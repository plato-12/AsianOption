---
title: "Theoretical Background: Asian Options with Price Impact"
author: "Priyanshu Tiwari"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEncoding{UTF-8}
  %\VignetteIndexEntry{Theoretical Background: Asian Options with Price Impact}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(AsianOption)
```

## Introduction

This vignette provides the mathematical foundation for pricing Asian
options with price impact using the Cox-Ross-Rubinstein (CRR) binomial
model.

## The CRR Binomial Model

In the standard CRR model, the stock price evolves on a binomial tree:

-   **Up move**: $S \to uS$ with risk-neutral probability $p$
-   **Down move**: $S \to dS$ with probability $1-p$

The risk-neutral probability ensures no-arbitrage:

$$p = \frac{r - d}{u - d}$$

where $r$ is the gross risk-free rate (e.g., $r = 1.05$ for 5%).

## Price Impact Mechanism

### Hedging-Induced Price Changes

When market makers hedge options, they must buy or sell the underlying
stock. Large volumes cause price movements:

$$\Delta S = \lambda \cdot v \cdot \text{sign}(\text{trade})$$

where: - $\lambda$: price impact coefficient - $v$: trading volume -
sign: +1 for buy, -1 for sell

### Modified Stock Dynamics

Incorporating hedging volumes $v^u$ (up move) and $v^d$ (down move):

$$\begin{aligned}
\tilde{u} &= u \cdot e^{\lambda v^u} \\
\tilde{d} &= d \cdot e^{-\lambda v^d}
\end{aligned}$$

The adjusted risk-neutral probability becomes:

$$p^{adj} = \frac{r - \tilde{d}}{\tilde{u} - \tilde{d}}$$

## Replicating Portfolio Method

### Fundamental Principle

At any node, we replicate the option using: - $\Delta$ shares of stock -
$B$ units of bonds

**Replication equations**:

$$\begin{cases}
\Delta \cdot S \tilde{u} + B \cdot r = V_{up} \\
\Delta \cdot S \tilde{d} + B \cdot r = V_{down}
\end{cases}$$

### Solving for the Replicating Portfolio

**Delta (hedge ratio)**:

$$\Delta = \frac{V_{up} - V_{down}}{S(\tilde{u} - \tilde{d})}$$

**Bond position**:

$$B = \frac{V_{down} - \Delta \cdot S \tilde{d}}{r}$$

**Option value**:

$$V = \Delta \cdot S + B = \frac{1}{r}[p^{eff} V_{up} + (1-p^{eff}) V_{down}]$$

## Geometric Asian Options

### Definition

Payoff at maturity:

$$V_n = \max\left(0, G_n - K\right)$$

where the geometric average is:

$$G_n = \left(\prod_{i=0}^{n} S_i\right)^{1/(n+1)}$$

### Path-Dependent Valuation

We must enumerate all $2^n$ paths $\omega \in \{U, D\}^n$:

$$V_0 = \frac{1}{r^n} \sum_{\omega} (p^{eff})^{\#U(\omega)} (1-p^{eff})^{\#D(\omega)} \max(0, G(\omega) - K)$$

### Example: n = 2

```{r}
# Price with n = 2
price_geometric_asian(
  S0 = 100, K = 100, r = 1.05,
  u = 1.2, d = 0.8,
  lambda = 0.1, v_u = 1, v_d = 1,
  n = 2
)
```

Four paths: UU, UD, DU, DD

-   **Path UU**: $G = S_0 \tilde{u}$
-   **Path UD**: $G = S_0 (\tilde{u}^2 \tilde{d})^{1/3}$
-   **Path DU**: $G = S_0 (\tilde{d}^2 \tilde{u})^{1/3}$
-   **Path DD**: $G = S_0 \tilde{d}$

Note: UD and DU have the same terminal price but **different geometric
averages**.

## Arithmetic Asian Options

### Definition

Payoff:

$$V_n = \max\left(0, A_n - K\right)$$

where:

$$A_n = \frac{1}{n+1} \sum_{i=0}^{n} S_i$$

### Bounds via Jensen's Inequality

**Lower bound** (AM-GM inequality):

$$A_n \geq G_n \implies V_0^A \geq V_0^G$$

**Upper bound** (reverse AM-GM):

$$V_0^A \leq V_0^G + \frac{(\rho^* - 1)}{r^n} \mathbb{E}^Q[G_n]$$

where:

$$\rho^* = \exp\left[\frac{(\tilde{u}^n - \tilde{d}^n)^2}{4 \tilde{u}^n \tilde{d}^n}\right]$$

### Example

```{r}
bounds <- arithmetic_asian_bounds(
  S0 = 100, K = 100, r = 1.05,
  u = 1.2, d = 0.8,
  lambda = 0.1, v_u = 1, v_d = 1,
  n = 3
)

print(bounds)
```

## No-Arbitrage Constraints

### Condition

For valid pricing, we require:

$$\tilde{d} < r < \tilde{u}$$

This ensures:

$$0 \leq p^{eff} \leq 1$$

### Checking Validity

```{r}
# Valid parameters
check_no_arbitrage(r = 1.05, u = 1.2, d = 0.8, lambda = 0.1, v_u = 1, v_d = 1)

# Invalid: r too high
check_no_arbitrage(r = 2.0, u = 1.2, d = 0.8, lambda = 0.1, v_u = 1, v_d = 1)
```

## Computational Complexity

### Exact Method: Path Enumeration

Path enumeration scales as $O(2^n)$:

| n   | Paths      | Approx. Time | Method   |
|-----|------------|--------------|----------|
| 10  | 1,024      | \< 1 ms      | Exact    |
| 15  | 32,768     | \~10 ms      | Exact    |
| 20  | 1,048,576  | \~10 sec     | Exact    |
| 25  | 33,554,432 | \~5 min      | Too slow |

**Challenge**: For $n > 20$, exact enumeration becomes impractical.

### Monte Carlo Method: Simulation

For large $n$, we use Monte Carlo simulation:

**Algorithm**:

1.  For $i = 1, \ldots, M$ (simulations):

    -   Generate random path:
        $\omega^{(i)} \sim \text{Bernoulli}(p^{adj})^n$
    -   Compute geometric average: $G(\omega^{(i)})$
    -   Calculate payoff: $\pi^{(i)} = \max(0, G(\omega^{(i)}) - K)$

2.  Estimate price:
    $\hat{V}_0 = \frac{1}{r^n} \cdot \frac{1}{M} \sum_{i=1}^M \pi^{(i)}$

3.  Compute standard error: $SE = \frac{\sigma_{\pi}}{r^n \sqrt{M}}$

**Performance**:

| n   | Simulations | Time    | Error (95% CI) |
|-----|-------------|---------|----------------|
| 25  | 100,000     | \~0.1 s | ± 0.5%         |
| 50  | 100,000     | \~0.2 s | ± 0.5%         |
| 100 | 100,000     | \~0.4 s | ± 0.5%         |

**Convergence**: By the Central Limit Theorem, $SE \propto 1/\sqrt{M}$.

### Automatic Method Selection

The package automatically selects the optimal method:

-   **n ≤ 20**: Exact enumeration (fast and exact)
-   **n \> 20**: Monte Carlo (fast with quantifiable error)

```{r}
# Auto-selects exact method
price_small <- price_geometric_asian(
  S0 = 100, K = 100, r = 1.05, u = 1.2, d = 0.8,
  lambda = 0.1, v_u = 1, v_d = 1, n = 10
)
cat("n=10 (exact):", price_small, "\n")

# Auto-selects Monte Carlo
price_large <- price_geometric_asian(
  S0 = 100, K = 100, r = 1.05, u = 1.2, d = 0.8,
  lambda = 0.1, v_u = 1, v_d = 1, n = 30, seed = 42
)
cat("n=30 (MC):", price_large, "\n")
```

### Monte Carlo with Full Output

For detailed analysis, use the direct Monte Carlo function:

```{r}
mc_result <- price_geometric_asian_mc(
  S0 = 100, K = 100, r = 1.05, u = 1.2, d = 0.8,
  lambda = 0.1, v_u = 1, v_d = 1, n = 25,
  n_simulations = 50000, seed = 123
)

print(mc_result)
```

The output includes: - **Price**: Estimated option value - **Std
Error**: Standard error of the estimate - **95% CI**: Confidence
interval for the true price - **Simulations**: Number of paths simulated

## References

Cox, J. C., Ross, S. A., & Rubinstein, M. (1979). Option pricing: A
simplified approach. *Journal of Financial Economics*, 7(3), 229-263.

Budimir, I., Dragomir, S. S., & Pečarić, J. (2000). Further reverse
results for Jensen's discrete inequality and applications in information
theory. *Journal of Inequalities in Pure and Applied Mathematics*, 2(1).

Glasserman, P. (2003). *Monte Carlo Methods in Financial Engineering*.
Springer.
